#!/bin/bash
#SBATCH --job-name=Align2dmel
#SBATCH -n 1
#SBATCH -N 1
#SBATCH -c 24
#SBATCH --mem=150G
#SBATCH --partition=general
#SBATCH --qos=general
#SBATCH --mail-type=ALL
#SBATCH --mail-user=asna.amjad@uconn.edu
#SBATCH -o %x_%j.out
#SBATCH -e %x_%j.err

echo `hostname`

module load cutadapt
module load fastqc
module load bowtie2/2.3.5.1
module load samtools/1.16.1
module load bedtools
module load ucsc_genome 

################## PRE-PROCESSING ##################
fastqc ${INpath}${INfileprefix}.fastq
cutadapt -j 24 -q 20 -m 100 -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -A AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT -o ${INpath}${INfileprefix}_R1_trimmed.fastq -p $ {INpath}${INfileprefix}_R2_trimmed.fastq ${INpath}${INfileprefix}_R1.fastq ${INpath}${INfileprefix}_R2.fastq
fastqc ${INpath}${INfileprefix}_trimmed.fastq

#### Bowtie2 Df Mapping ####
############################
bowtie2 -p 24 -t -x $REF -1 Emb_RNAseq_R1_trimmed.fastq.gz -2 Emb_RNAseq_R2_trimmed.fastq.gz | \
        samtools view -@ 24 -F 1548 -bS | samtools sort -O bam -o \
        RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_sort.bam

#### Bowtie2 K-100 Mapping ####
###############################
bowtie2 -p 24 -t -k 100 -x $REF -1 Emb_RNAseq_R1_trimmed.fastq.gz -2 Emb_RNAseq_R2_trimmed.fastq.gz | \
        samtools view -@ 24 -F 1548 -bS | samtools sort -O bam -o \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_sort.bam

#### Split Bt2 Df Files ####
############################

bedtools genomecov -bg -split -strand + -ibam RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_sort.bam contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_plus.bedgraph
bedtools genomecov -bg -split -strand - -ibam RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_sort.bam contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus.bedgraph

awk '{ $4=$4*-1; print }' RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus_mod.bedgraph

export LC_COLLATE=C
sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_plus.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_plus_sort.bedgraph
sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus_mod.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus_mod_sort.bedgraph

bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_plus_sort.bedgraph contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_plus.bigwig
bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus_sort.bedgraph contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_minus.bigwig

#### Split Bt2 K-100 Files ####
###############################

bedtools genomecov -bg -split -strand + -ibam RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_sort.bam contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F154$
bedtools genomecov -bg -split -strand - -ibam RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_sort.bam contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F154$

awk '{ $4=$4*-1; print }' RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus_mod.bedgraph

export LC_COLLATE=C
sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_plus.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_plus_sort.bedgraph
sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus_mod.bedgraph > RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus_mod_sort.bedgraph

bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_plus_sort.bedgraph contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_plus.bigwig
bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus_sort.bedgraph contigs.size RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_minus.bigwig

bedtools bamtobed -i RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548_sort.bam > RNAseq-sample_cutadapt-q20-m100_BT2-Df-Dmel-F1548.bed
bedtools bamtobed -i RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_sort.bam > RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548.bed

#### Overlap 51-mer Meryl ####
##############################

overlapSelect -overlapBases=51 /home/FCAM/aamjad/Meryl_kmers_new/dmel_assembly_51mer_SINGLEv1.3.meryl_merge.bed RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548.bed \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge.bed
#### Split K100 filtered Files ####
###################################

awk '$6 == "+"' RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge.bed | genomeCoverageBed -i contigs.size > \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus.bedgraph
awk '$6 == "-"' RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge.bed | genomeCoverageBed -i contigs.size > \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus.bedgraph

awk '{ $4=$4*-1; print }' RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus.bedgraph > \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus_mod.bedgraph

export LC_COLLATE=C
sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus.bedgraph > \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus_sort.bedgraph

sort -k1,1 -k2,2n RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus_mod.bedgraph > \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus_sort.bedgraph

bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus_sort.bedgraph contigs.size \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus.bigwig

bedGraphToBigWig RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_plus_minus.bedgraph contigs.size \
        RNAseq-sample_cutadapt-q20-m100_BT2-k100-Dmel-F1548_OVER_Meryl_uniq51mer_Dmel-merge_minus.bigwig
