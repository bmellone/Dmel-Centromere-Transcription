####Unique kmer filtering pipeline####
###The following steps were applied to the PROseq mapped data

#bedtools bamtobed -i ../PROseq_Trim_R1_bt2-k100-Dmel_sort.bam > PROseq_RevComp_Trim_SE_bt2-k100-Dmel.bed

### Step 3b: Get 3' ends (position of polymerase) & convert to bedgraph
################################################################################
#cat PROseq_RevComp_Trim_SE_bt2-k100-Dmel.bed |
#awk '{OFS="\t"} $6=="+" {print $1,($3-1),$3,$4,$5"_"($3-$2),$6}; $6=="-" {print $1,$2,($2+1),$4,$5"_"($3-$2),$6}' |
#       sort --parallel 12 -k1,1 -k2,2n > PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends.bed

##Convert to bedgraph:
#awk '$6 == "+"' PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
#       PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_plus.bedgraph
#awk '$6 == "-"' PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
#       PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_m.bedgraph
#awk '{OFS="\t"}{ $4=$4*-1; print }' PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_m.bedgraph > PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_minus.bedgraph

################################################################################
### Step 3d: OverlapSelect read pairs with unique kmers, get 3' end per pair, & convert to bedgraph
################################################################################
#overlapSelect -overlapBases=51 /home/FCAM/aamjad/Meryl1.4.1Kmers/dmel_scaffold2_plus0310_51mer_SINGLEv1.4.1.meryl_merge.bed \
#        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.bed \
#        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged.bed 

##Get single-bp coords (start of R1):
#cat PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged.bed |
#       awk '{OFS="\t"} $6=="+" {print $1,($3-1),$3,$4,$5"_"($3-$2),$6}; $6=="-" {print $1,$2,($2+1),$4,$5"_"($3-$2),$6}' |
#       sort --parallel 12 -k1,1 -k2,2n > PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends.bed

##Convert to bedgraph:
#awk '$6 == "+"' PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
#       PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_plus.bedgraph
#awk '$6 == "-"' PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
#       PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_m.bedgraph
#awk '{OFS="\t"}{ $4=$4*-1; print }' PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_m.bedgraph > \
#       PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_minus.bedgraph

############# Bt2 SE K-100 ###############
#export LC_COLLATE=C
#       sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_plus.bedgraph > PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_plus_sort.bedgraph
#       sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_minus.bedgraph > PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_minus_sort.bedgraph 

#bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_plus_sort.bedgraph contigs.size PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_plus.bigwig
#bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_minus_sort.bedgraph contigs.size PROseq_RevComp_Trim_SE_bt2-k100-Dmel_3ends_minus.bigwig

############### SE K-100 21-mer ###############
export LC_COLLATE=C
sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_plus.bedgraph > \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_plus_sort.bedgraph    
sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_minus.bedgraph > \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_minus_sort.bedgraph

bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_plus_sort.bedgraph contigs.size \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_plus.bigwig
bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_minus_sort.bedgraph contigs.size \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.21mer.single.meryl.merged_3ends_minus.bigwig

############### SE K-100 51-mer ###############
export LC_COLLATE=C
sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_plus.bedgraph > \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_plus_sort.bedgraph
sort -k1,1 -k2,2n PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_minus.bedgraph > \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_minus_sort.bedgraph

bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_plus_sort.bedgraph contigs.size \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_plus.bigwig
bedGraphToBigWig PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_minus_sort.bedgraph contigs.size \
        PROseq_RevComp_Trim_SE_bt2-k100-Dmel.over.FullAsm.51mer.single.meryl.merged_3ends_minus.bigwig
