#!/bin/bash
#SBATCH --job-name=Align2dmel
#SBATCH -n 1
#SBATCH -N 1
#SBATCH -c 24
#SBATCH --mem=150G
#SBATCH --partition=general
#SBATCH --qos=general
#SBATCH --mail-type=ALL
#SBATCH --mail-user=asna.amjad@uconn.edu
#SBATCH -o %x_%j.out
#SBATCH -e %x_%j.err

echo `hostname`

module load cutadapt
module load fastqc
module load bowtie2/2.3.5.1
module load samtools/1.16.1
module load bedtools
module load ucsc_genome

mkdir fastq_Trim

INpath=/path/to/input/directory/
INfileprefix=SAMPLE1
DmelanogasterIndex=/labs/Mellone/Asna/Assembly/bowtie2_Index/dmel_scaffold2_plus0310.fasta
OUTpath=/path/to/output/directory/

################## PRE-PROCESSING ##################
fastqc ${INpath}${INfileprefix}.fastq
cutadapt -j 24 -q 20 -m 20 -a TGGAATTCTCGGGTGCCAAGG -A GATCGTCGGACTGTAGAACTCTGAAC -o ${INpath}${INfileprefix}_R1_trim.fastq.gz -p $ {INpath}${INfileprefix}_R2_Trim.fastq.gz \
  ${INpath}${INfileprefix}_R1.fastq.gz ${INpath}${INfileprefix}_R2.fastq.gz
fastqc ${INpath}${INfileprefix}_trimmed.fastq
fastx_reverse_complement -Q33 -v -i ${INpath}${INfileprefix}_R1_trimmed.fastq -o ${INpath}${INfileprefix}_R1_trimmed_RC.fastq
fastx_reverse_complement -Q33 -v -i ${INpath}${INfileprefix}_R2_trimmed.fastq -o ${INpath}${INfileprefix}_R2_trimmed_RC.fastq
################## FILTERING OUT HeLa Cells SPIKE-INS IN PROSEQ DATA ONLY ##################

bowtie2 -p 24 -t --very-sensitive -x ${HumangenomeIndex} -1 ${INpath}${INfileprefix}_R1_trimmed_RC.fastq -2 ${INpath}${INfileprefix}_R2_trimmed_RC.fastq | samtools view -@ 24 -bS | samtools sort -O bam -o ${INpath}${INfileprefix}_trimmed_RC_BT2-vs-Hg_sort.bam


#bowtie2 -p 24 -t -x Dmel_hg38_combine -1 /labs/Mellone/Asna/ProSeq_New_Mapping/fastq_Trim/ProSeq_5_R1_Trim_RevComp.fastq.gz \
#       -2 /labs/Mellone/Asna/ProSeq_New_Mapping/fastq_Trim/ProSeq_5_R2_Trim_RevComp.fastq.gz | \
#       samtools view -@ 24 -F 1548 -bS | \
#       samtools sort -@ 24 -m 3G -O bam -o PROseq_Emb_RevComp_BT2_Df_CombineHgDmel_sort.bam

#samtools view -@ 24 -hf 0x2 PROseq_Emb_BT2_Df_Dmel_sort.bam |
 #   awk '($1 ~/^@/ || $2==99 || $2==147)' |
  #  samtools sort -n -@ 24 |
   # bedtools bamtobed -bedpe -i stdin |
    #awk '{OFS="\t"} {print $1,$2,$6,$7,$8,"-"}' > PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk.bed
    #samtools view -@ 24 -hf 0x2 PROseq_Emb_BT2_Df_Dmel_sort.bam |
    #awk '($1 ~/^@/ || $2==83 || $2==163)' |
    #samtools sort -n -@ 24 |
    #bedtools bamtobed -bedpe -i stdin |
    #awk '{OFS="\t"} {print $1,$2,$6,$7,$8,"+"}' >> PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk.bed


 ### Step 3b: Get 3' ends per pair (position of polymerase) & convert to bedgraph
        ##Get single-bp coords (start of R1):
          # cat PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk.bed |
           #awk '{OFS="\t"} $6=="+" {print $1,($3-1),$3,$4,$5"_"($3-$2),$6}; $6=="-" {print $1,$2,($2+1),$4,$5"_"($3-$2),$6}' |
           #sort --parallel 12 -k1,1 -k2,2n > PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends.bed
        ##Convert to bedgraph:
            awk '$6 == "+"' PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
                                PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_plus.bedgraph
            awk '$6 == "-"' PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends.bed | genomeCoverageBed -3 -i /dev/stdin -bg -g contigs.size > \
                                PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_m.bedgraph
            awk '{OFS="\t"}{ $4=$4*-1; print }' PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_m.bedgraph > \
                                PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_minus.bedgraph

export LC_COLLATE=C
        sort -k1,1 -k2,2n PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_plus.bedgraph > PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_plus_sort.bedgraph
        sort -k1,1 -k2,2n PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_minus.bedgraph > PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_minus_sort.bedgraph


#(samtools view -@ 24 -H New/PROseq_Emb_BT2_Df_CombineHgDmel_sort.bam
#samtools view -@ 24 New/PROseq_Emb_BT2_Df_CombineHgDmel_sort.bam | grep -f contigs.txt) | \
#samtools view -@ 24 -b > PROseq_Emb_BT2_Df_Dmel_sort.bam

bedGraphToBigWig PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_plus_sort.bedgraph contigs.size PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_plus.bigwig
bedGraphToBigWig PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_minus_sort.bedgraph contigs.size PROseq_Emb_BT2_Df_Dmel_nameSort_withAwk_3ends_minus.bigwig  


################## PULL OUT UNMAPPED PROseq READS AND CONVERT TO FASTQ ######################
samtools view -@ 20 -b -f 4 -o ${INpath}${INfileprefix}_trimmed_RC_sort_unmapped2HG.bam ${INpath}${INfileprefix}_trimmed_RC_BT2-vs-Hg_sort.bam                  
samtools fastq ${INpath}${INfileprefix}_trimmed_RC_sort_unmapped.bam > ${INpath}${INfileprefix}_trimmed_RC_sort_unmapped2Hg.fastq

################## MAPPING TO DROSOPHILA HET-ENRICHED ASSEMBLY (BT2 DF & BT2 K100) ##################
bowtie2 -p 24 -t -x ${DmelanogasterIndex} -1 ${INpath}${INfileprefix}_R1_trimmed_RC_sort_unmapped2Hg.fastq -2 ${INpath}${INfileprefix}_R2_trimmed_RC_sort_unmapped2Hg.fastq | samtools view -@ 24 -bS | samtools sort -O bam -o ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bam
bowtie2 -p 24 -t -k 100 -x ${DmelanogasterIndex} -1 ${INpath}${INfileprefix}_R1_trimmed_RC_sort_unmapped2Hg.fastq -2 ${INpath}${INfileprefix}_R2_trimmed_RC_sort_unmapped2Hg.fastq | samtools view -@ 24 -bS | samtools sort -O bam -o ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-K100_mapped2DM_sort.bam

################# CONVERT SORT.BAM TO BEDGRAPGH, SORT, TO BIGWIG FOR VIEWING ##################
 bedtools genomecov -bg -ibam ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bam > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM.bedgraph
export LC_COLLATE=C
sort -k1,1 -k2,2n ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM.bedgraph > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bedgraph             
bedGraphToBigWig ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bedgraph ~/assembly/contigs.size ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM.bigwig

################ CONVERT SORT.BAM TO .BED FOR FILTERING THROUGH UNIQUE ASSEMBLY KMERS ################
bedtools bamtobed -i ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bam > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bed 

################ CHECK INSERT SIZE ###############
mkdir insert
module load java
module load picard
java -Xmx10g -jar /isg/shared/apps/picard/picard-tools-2.9.2/picard.jar CollectInsertSizeMetrics \
      I=${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bam \
      O=${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort_insert_size_metrics.txt \
      H=${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort_insert_size_histogram.pdf \
      M=0.5
################## FILTER MAPPED READS THROUGH MERYL UNIQUE ASSEMBLY KMERS ##################
### Overlap .bed with Meryl unique 21mers:
overlapSelect -overlapBases=21 /home/FCAM/aamjad/Meryl_kmers/dmel_assembly_21mer_SINGLEv1.3.meryl_merge.bed ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bed ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bed 

### For 21mer overlaps: convert bed to bedgraph, sort, then to bigwig for viewing:
bedtools genomecov -bg -i ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bed -g contigs.size > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bedgraph
        export LC_COLLATE=C
    	sort -k1,1 -k2,2n ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bedgraph > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge-sort.bedgraph
        bedGraphToBigWig ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge-sort.bedgraph contigs.size ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge-sort.bigwig

### Overlap .bed with Meryl unique 51mers:
overlapSelect -overlapBases=51 /home/FCAM/aamjad/Meryl_kmers/dmel_assembly_51mer_SINGLEv1.3.meryl_merge.bed ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_mapped2DM_sort.bed ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq51mer-merge.bed 

### For 51mer overlaps: convert bed to bedgraph, sort, then to bigwig for viewing:
bedtools genomecov -bg -i ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bed -g contigs.size > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq21mer-merge.bedgraph
        export LC_COLLATE=C
    	sort -k1,1 -k2,2n ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq51mer-merge.bedgraph > ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq51mer-merge-sort.bedgraph
        bedGraphToBigWig ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq51mer-merge-sort.bedgraph contigs.size ${OUTpath}${INfileprefix}_trimmed_RC_sort_BT2-Df_F_1548_OVER_Meryl_uniq51mer-merge-sort.bigwig
## K100 Pipeline ##
###################
#RC: 
#seqkit seq --reverse --complement ProSeq_5_R1_Trim.fastq.gz > PROseq_Trim_R1_RC.fastq.gz

#Map: 
#bowtie2 -p 24 -t --very-sensitive -x /labs/Mellone/Asna/ProSeq_New_Mapping/fastq_Trim/AlignProSeqDec23/hg38_bowtie2/Human_genome \
#       -U PROseq_Trim_R1_RC.fastq.gz | samtools view -@ 24 -bS | \
#       samtools sort -@ 24 -m 3G -O bam -o PROseq_Trim_R1_RC_BT2-vs-Hg_sort.bam

##Pull out UNMAPPED PROseq reads only from sort.bam and convert to fastq:
    ##Usage: (-f 4) results in retaining only those reads that did NOT map to Human genome 

#samtools view -@ 24 -b -f 4 -o PROseq_Trim_R1_RC_BT2-vs-Hg_sort_unmapped.bam PROseq_Trim_R1_RC_BT2-vs-Hg_sort.bam
#samtools fastq -@ 24 PROseq_Trim_R1_RC_BT2-vs-Hg_sort_unmapped.bam > PROseq_Trim_R1_RC_BT2-vs-Hg_sort_unmapped.fastq

# Map to Drosophila
#bowtie2 -p 24 -t -k 100 -x /labs/Mellone/Asna/Assembly/bt2_Index/dmel_scaffold2_plus0310.fasta \
#       -U PROseq_Trim_R1_RC_BT2-vs-Hg_sort_unmapped.fastq | \
#       samtools view -@ 24 -bS | samtools sort -@ 24 -m 3G -O bam -o PROseq_Trim_R1_bt2-k100-Dmel_sort.bam

# sort.bam to bed: 
#bedtools bamtobed -i PROseq_Trim_R1_bt2-k100-Dmel_sort.bam > PROseq_Trim_R1_bt2-k100-Dmel.bed
